groups:
- name: server
  interval: 5s
  rules:
  - alert: Under-voltage detected
    expr: 'count_over_time({job="journal"} |= "Undervoltage detected"[10m]) > 0'
    for: 0m
    labels:
      severity: warn
    annotations:
      summary: "Instance {{ $labels.node }} Under-voltage detected"
      description: "電圧不足のため電源交換を実施"
  - alert: I/O error
    expr: 'count_over_time({job="journal"} |= "I/O error"[10m]) > 0'
    for: 0m
    labels:
      severity: alert
    annotations:
      summary: "Instance {{ $labels.node }} I/O error"
      description: "ディスクがI/Oエラーで認識できていないのでサーバの再起動を実施"
  - alert: Kernel error
    expr: 'count_over_time({job="journal"} |~ "Error|error"[10m]) > 0'
    for: 5m
    labels:
      severity: alert
    annotations:
      summary: "Instance {{ $labels.node }} Kernel error"
      description: "システムエラーになっているUnitを確認して対処"
  - alert: minecraft bedrock server user connected
    expr: 'count_over_time({namespace="prod-minecraft"}|~ "Player connected"[10m]) > 0'
    for: 5m
    labels:
      severity: info
    annotations:
      summary: "Minecraft bedrock server user connected"
  - alert: longhorn buckup error
    expr: 'count_over_time({namespace="longhorn-system"} |= "cannot mount nfs"[1m]) > 0'
    for: 0m
    labels:
      severity: alert
    annotations:
      summary: "longhorn-system {{ $labels.node }} cannot mount nfs"
      description: "NFSサーバの状態確認を実施"
- name: application
  interval: 5s
  rules:
  - alert: "Remote Storage error"
    expr: 'count_over_time({app_kubernetes_io_name="prometheus"} |~ `level=error` |~ `component=remote` |~ `msg="non-recoverable error"`[5m]) > 0'
    for: 5m
    labels:
      severity: alert
    annotations:
      summary: "prometheus remote write error"
      description: "PrometheusのRemoteWrite周りを確認"
  - alert: oom_killer
    expr: 'count_over_time({job="journal"} |= "Memory cgroup out of memory"[10m]) > 0'
    for: 0m
    labels:
      severity: alert
      airflow_trigger: oom_killer
    annotations:
      summary: "Instance {{ $labels.node }} Memory cgroup out of memory"
      description: "アプリケーションがメモリ不足のためresourcesを調整する"
  - alert: "Unauthorized access detection"
    expr: 'count_over_time({namespace="ingress-nginx"} |~ "HTTP/[1-2]\\.[0-2]\"\\s4[0-9]{2}\\s" |~ "/wp-login.php"[1m]) > 1'
    for: 0m
    labels:
      severity: alert
    annotations:
      summary: "wordpressのログインURLにアクセス試行"
      description: "アクセス内容を確認して必要であれば該当のIPをdenyに追加"
  - alert: "vault_failed_to_heartbeat_to_peer"
    expr: 'count_over_time({app_kubernetes_io_name="vault"}  |="storage.raft: failed to heartbeat to: peer"[1m]) > 0'
    for: 0m
    labels:
      severity: alert
    annotations:
      summary: "vault で raft peers のハートビート監視で失敗"
      description: "vault を確認して raft peers を構成してください"